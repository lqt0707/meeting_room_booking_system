# 定义后端服务
upstream backend {
    server host.docker.internal:3005;
}

# 定义前端管理界面服务
upstream frontend-admin {
    server host.docker.internal:3001;
}

# 定义前端用户界面服务
upstream frontend-user {
    server host.docker.internal:3000;
}

# 示例：其他项目的upstream配置
# upstream another-backend {
#     server host.docker.internal:3006;  # 假设新后端项目监听3006端口
# }
#
# upstream another-frontend {
#     server host.docker.internal:3002;  # 假设新前端项目监听3002端口
# }

server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    # 重定向根API路径到API文档
    location = /api {
        return 302 /api-doc;
    }

    # 代理后端API请求
    location ^~ /api {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 代理前端管理界面的静态资源
    location ^~ /admin/static/ {
        rewrite ^/admin/static/(.*)$ /static/$1 break;
        proxy_pass http://frontend-admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";
    }

    # 代理前端管理界面（支持React Router）
    location /admin {
        proxy_pass http://frontend-admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Accept-Encoding "";
    }

    # 代理前端用户界面
    location / {
        proxy_pass http://frontend-user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 示例：其他项目的location配置
    # location ^~ /another-api {
    #     rewrite ^/another-api/(.*)$ /$1 break;
    #     proxy_pass http://another-backend;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    #
    # location /another-frontend {
    #     proxy_pass http://another-frontend;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}